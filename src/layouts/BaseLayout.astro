---
import '@fontsource/inter/400.css';
import '@fontsource/inter/500.css';
import '@fontsource/inter/600.css';
import '@fontsource/inter/700.css';
import '../styles/global.css';
import ThemeToggle from '../components/ThemeToggle.astro';
import LanguageSwitcher from '../components/LanguageSwitcher.astro';
import { getLocaleFromUrl, getTranslations, getLocalizedPath } from '../i18n/utils';

export interface Props {
  title: string;
  description?: string;
  lang?: 'de' | 'en';
}

const currentLocale = Astro.props.lang || getLocaleFromUrl(Astro.url);
const t = getTranslations(currentLocale);

const { title, description = currentLocale === 'de'
  ? 'ConnexaLine – Ihr Partner für moderne Telekommunikations und Glasfaserinfrastruktur.'
  : 'ConnexaLine – Your partner for modern telecommunications and fiber optic infrastructure.'
} = Astro.props;
const base = import.meta.env.BASE_URL;

// Helper function to get localized paths
const localPath = (path: string) => getLocalizedPath(path, currentLocale);

// Helper function to check if current page
const currentPath = Astro.url.pathname.replace(/\/$/, '');
const isActive = (path: string) => {
  const targetPath = localPath(path).replace(/\/$/, '');
  return currentPath === targetPath || currentPath === targetPath.replace(/\/$/, '');
};
---

<!DOCTYPE html>
<html lang={currentLocale}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href={`${base}favicon.svg`} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
    <title>{title} | ConnexaLine</title>
    <script is:inline>
      // Apply theme immediately to prevent flash
      (function() {
        const savedTheme = localStorage.getItem('theme');
        const prefersLight = window.matchMedia('(prefers-color-scheme: light)').matches;
        if (savedTheme === 'light' || (!savedTheme && prefersLight)) {
          document.documentElement.classList.add('light');
        }
      })();
    </script>
    <script src="../scripts/animations.ts"></script>
  </head>
  <body>
    <div id="scroll-progress" class="scroll-progress" aria-hidden="true"></div>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <header id="header" class="header">
      <nav class="container-custom">
        <div class="nav-inner">
          <a href={localPath('')} class="nav-logo">
            <img src={`${base}images/logo-white.svg`} alt="ConnexaLine" class="nav-logo-img nav-logo-img-dark" />
            <img src={`${base}images/logo.svg`} alt="ConnexaLine" class="nav-logo-img nav-logo-img-light" />
          </a>

          <div class="nav-links">
            <a href={localPath('')} class:list={['nav-link', { active: isActive('') }]} aria-current={isActive('') ? 'page' : undefined}>{t.nav.home}</a>
            <a href={localPath('services')} class:list={['nav-link', { active: isActive('services') }]} aria-current={isActive('services') ? 'page' : undefined}>{t.nav.services}</a>
            <a href={localPath('projects')} class:list={['nav-link', { active: isActive('projects') }]} aria-current={isActive('projects') ? 'page' : undefined}>{t.nav.projects}</a>
            <a href={localPath('about')} class:list={['nav-link', { active: isActive('about') }]} aria-current={isActive('about') ? 'page' : undefined}>{t.nav.about}</a>
            <a href={localPath('contact')} class="btn-primary btn-nav">{t.nav.contact}</a>
            <div class="nav-actions">
              <LanguageSwitcher />
              <ThemeToggle />
            </div>
          </div>

          <div class="mobile-actions">
            <LanguageSwitcher />
            <ThemeToggle />
            <button id="mobile-menu-btn" class="mobile-menu-btn" aria-label="Menü öffnen" aria-expanded="false" aria-controls="mobile-menu">
              <svg class="menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
              </svg>
            </button>
          </div>
        </div>
      </nav>

      <div id="mobile-menu" class="mobile-menu">
        <div class="container-custom">
          <a href={localPath('')} class:list={['mobile-link', { active: isActive('') }]} aria-current={isActive('') ? 'page' : undefined}>{t.nav.home}</a>
          <a href={localPath('services')} class:list={['mobile-link', { active: isActive('services') }]} aria-current={isActive('services') ? 'page' : undefined}>{t.nav.services}</a>
          <a href={localPath('projects')} class:list={['mobile-link', { active: isActive('projects') }]} aria-current={isActive('projects') ? 'page' : undefined}>{t.nav.projects}</a>
          <a href={localPath('about')} class:list={['mobile-link', { active: isActive('about') }]} aria-current={isActive('about') ? 'page' : undefined}>{t.nav.about}</a>
          <a href={localPath('contact')} class="btn-primary mobile-btn">{t.nav.contact}</a>
        </div>
      </div>
    </header>

    <main id="main-content">
      <slot />
    </main>

    <footer class="footer">
      <div class="container-custom">
        <div class="footer-top">
          <div class="footer-brand">
            <a href={localPath('')} class="footer-logo">
              <img src={`${base}images/logo-white.svg`} alt="ConnexaLine" class="footer-logo-img footer-logo-img-dark" />
              <img src={`${base}images/logo.svg`} alt="ConnexaLine" class="footer-logo-img footer-logo-img-light" />
            </a>
            <p class="footer-tagline">
              {t.footer.tagline}<br/>
              {t.footer.taglineSubtitle}
            </p>
          </div>

          <div class="footer-nav">
            <h4 class="footer-nav-title">{t.footer.navigation}</h4>
            <ul class="footer-nav-list">
              <li><a href={localPath('')}>{t.nav.home}</a></li>
              <li><a href={localPath('services')}>{t.nav.services}</a></li>
              <li><a href={localPath('projects')}>{t.nav.projects}</a></li>
              <li><a href={localPath('about')}>{t.nav.about}</a></li>
              <li><a href={localPath('contact')}>{t.nav.contact}</a></li>
            </ul>
          </div>

          <div class="footer-nav">
            <h4 class="footer-nav-title">{t.footer.services}</h4>
            <ul class="footer-nav-list">
              <li><a href={localPath('services/ftth')}>{t.footer.ftth}</a></li>
              <li><a href={localPath('services/infrastructure')}>{t.footer.infrastructure}</a></li>
              <li><a href={localPath('services/maintenance')}>{t.footer.maintenance}</a></li>
            </ul>
          </div>

          <div class="footer-nav">
            <h4 class="footer-nav-title">{t.footer.legal}</h4>
            <ul class="footer-nav-list">
              <li><a href={currentLocale === 'de' ? `${base}impressum` : `${base}en/imprint`}>{t.footer.imprint}</a></li>
              <li><a href={currentLocale === 'de' ? `${base}datenschutz` : `${base}en/privacy`}>{t.footer.privacy}</a></li>
            </ul>
          </div>

          <div class="footer-nav footer-contact">
            <h4 class="footer-nav-title">{t.footer.contact}</h4>
            <ul class="footer-nav-list footer-contact-list">
              <li>
                <a href={`tel:${t.footer.phone.replace(/\s/g, '')}`} class="footer-contact-link">
                  <svg class="footer-contact-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                  </svg>
                  {t.footer.phone}
                </a>
              </li>
              <li>
                <a href={`mailto:${t.footer.email}`} class="footer-contact-link">
                  <svg class="footer-contact-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                  {t.footer.email}
                </a>
              </li>
              <li class="footer-address">
                <svg class="footer-contact-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span>{t.footer.address}</span>
              </li>
            </ul>
          </div>
        </div>

        <div class="footer-bottom">
          <p>{t.footer.copyright}</p>
        </div>
      </div>
    </footer>

    <style>
      .scroll-progress {
        position: fixed;
        top: 0;
        left: 0;
        width: 0%;
        height: 3px;
        background: linear-gradient(90deg, var(--color-primary), var(--color-primary-hover));
        z-index: 9999;
        transition: width 0.1s ease-out;
      }

      .skip-link {
        position: absolute;
        top: -100%;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        padding: 0.75rem 1.5rem;
        background: var(--color-primary);
        color: #0B0E11;
        font-weight: 500;
        font-size: 0.875rem;
        border-radius: 0 0 0.5rem 0.5rem;
        text-decoration: none;
        transition: top 0.2s ease;
      }

      .skip-link:focus {
        top: 0;
        outline: none;
      }

      .header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 100;
        transition: all 0.3s ease;
      }

      .header.scrolled {
        background: var(--color-background);
        opacity: 0.95;
        backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--color-border);
      }

      .nav-inner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 4rem;
        padding: 0.5rem 0;
      }

      @media (min-width: 768px) {
        .nav-inner {
          height: 5rem;
          padding: 0;
        }
      }

      .nav-logo {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        text-decoration: none;
        transition: opacity 0.2s ease;
      }

      .nav-logo:hover {
        opacity: 0.8;
      }

      .nav-logo-img {
        height: 2rem;
        width: auto;
      }

      @media (min-width: 768px) {
        .nav-logo-img {
          height: 2.5rem;
        }
      }

      .nav-logo-img-dark {
        display: block;
      }

      .nav-logo-img-light {
        display: none;
      }

      :global(.light) .nav-logo-img-dark {
        display: none;
      }

      :global(.light) .nav-logo-img-light {
        display: block;
      }

      .nav-logo-icon {
        width: 2rem;
        height: 2rem;
        color: var(--color-primary);
      }

      .nav-logo-icon svg {
        width: 100%;
        height: 100%;
      }

      .nav-logo-text {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--color-foreground);
      }

      .nav-links {
        display: none;
        align-items: center;
        gap: 2rem;
      }

      @media (min-width: 768px) {
        .nav-links {
          display: flex;
        }
      }

      .nav-link {
        font-size: 0.9375rem;
        font-weight: 500;
        color: var(--color-text-secondary);
        text-decoration: none;
        transition: color 0.2s ease;
      }

      .nav-link:hover {
        color: var(--color-foreground);
      }

      .nav-link.active {
        color: var(--color-primary);
        position: relative;
      }

      .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: -4px;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--color-primary);
        border-radius: 1px;
      }

      .btn-nav {
        padding: 0.625rem 1.25rem;
      }

      .nav-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-left: 0.5rem;
      }

      .mobile-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      @media (min-width: 768px) {
        .mobile-actions {
          display: none;
        }
      }

      .mobile-menu-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 2.75rem;
        height: 2.75rem;
        background: transparent;
        border: 1px solid var(--color-border-light);
        border-radius: 0.5rem;
        color: var(--color-foreground);
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
        -webkit-tap-highlight-color: transparent;
      }

      .mobile-menu-btn:hover {
        background: var(--color-border);
        border-color: var(--color-surface-border);
      }

      @media (min-width: 768px) {
        .mobile-menu-btn {
          display: none;
        }
      }

      .menu-icon {
        width: 1.25rem;
        height: 1.25rem;
      }

      .mobile-menu {
        display: none;
        background: var(--color-surface);
        border-top: 1px solid var(--color-border);
        padding: 1.5rem 0;
      }

      .mobile-menu.open {
        display: block;
      }

      .mobile-link {
        display: block;
        padding: 1rem 0;
        font-size: 1.0625rem;
        font-weight: 500;
        color: var(--color-text-secondary);
        text-decoration: none;
        border-bottom: 1px solid var(--color-border);
        transition: all 0.2s ease;
        -webkit-tap-highlight-color: transparent;
      }

      .mobile-link:hover {
        color: var(--color-foreground);
      }

      .mobile-link.active {
        color: var(--color-primary);
        border-left: 3px solid var(--color-primary);
        padding-left: 0.75rem;
      }

      .mobile-btn {
        display: inline-flex;
        margin-top: 1rem;
      }

      .footer {
        background: var(--color-background-alt);
        border-top: 1px solid var(--color-border);
        padding-top: 4rem;
        padding-bottom: 2rem;
      }

      .footer-top {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2.5rem;
        padding-bottom: 3rem;
        border-bottom: 1px solid var(--color-border);
      }

      @media (min-width: 640px) {
        .footer-top {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (min-width: 1024px) {
        .footer-top {
          grid-template-columns: 2fr 1fr 1fr 1fr;
        }
      }

      .footer-logo {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        text-decoration: none;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--color-foreground);
        margin-bottom: 1rem;
      }

      .footer-logo-img {
        height: 2rem;
        width: auto;
      }

      .footer-logo-img-dark {
        display: block;
      }

      .footer-logo-img-light {
        display: none;
      }

      :global(.light) .footer-logo-img-dark {
        display: none;
      }

      :global(.light) .footer-logo-img-light {
        display: block;
      }

      .footer-tagline {
        font-size: 0.9375rem;
        line-height: 1.7;
        color: var(--color-muted-dark);
      }

      .footer-nav-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--color-foreground);
        margin-bottom: 1rem;
      }

      .footer-nav-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .footer-nav-list li {
        margin-bottom: 0.625rem;
      }

      .footer-nav-list a {
        font-size: 0.875rem;
        color: var(--color-muted-dark);
        text-decoration: none;
        transition: color 0.2s ease;
      }

      .footer-nav-list a:hover {
        color: var(--color-primary);
      }

      .footer-contact-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .footer-contact-link {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.875rem;
        color: var(--color-muted-dark);
        text-decoration: none;
        transition: color 0.2s ease;
      }

      .footer-contact-link:hover {
        color: var(--color-primary);
      }

      .footer-contact-icon {
        width: 1.25rem;
        height: 1.25rem;
        flex-shrink: 0;
        color: var(--color-primary);
      }

      .footer-address {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        font-size: 0.875rem;
        color: var(--color-muted-dark);
      }

      .footer-bottom {
        padding-top: 2rem;
        text-align: center;
      }

      .footer-bottom p {
        font-size: 0.8125rem;
        color: var(--color-text-tertiary);
      }
    </style>

    <script>
      const header = document.getElementById('header');
      const mobileMenuBtn = document.getElementById('mobile-menu-btn');
      const mobileMenu = document.getElementById('mobile-menu');
      const scrollProgress = document.getElementById('scroll-progress');

      window.addEventListener('scroll', () => {
        if (window.scrollY > 50) {
          header?.classList.add('scrolled');
        } else {
          header?.classList.remove('scrolled');
        }

        // Update scroll progress bar
        if (scrollProgress) {
          const scrollTop = window.scrollY;
          const docHeight = document.documentElement.scrollHeight - window.innerHeight;
          const scrollPercent = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
          scrollProgress.style.width = `${scrollPercent}%`;
        }
      });

      mobileMenuBtn?.addEventListener('click', () => {
        const isOpen = mobileMenu?.classList.toggle('open');
        mobileMenuBtn?.setAttribute('aria-expanded', String(isOpen));
        mobileMenuBtn?.setAttribute('aria-label', isOpen ? 'Menü schließen' : 'Menü öffnen');
      });

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add('is-visible');
              observer.unobserve(entry.target);
            }
          });
        },
        { threshold: 0.1, rootMargin: '0px 0px -50px 0px' }
      );

      document.querySelectorAll('.animate-fade-up').forEach((el) => {
        observer.observe(el);
      });
    </script>
  </body>
</html>
